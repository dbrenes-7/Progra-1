#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#define TAMANO 300

typedef struct Lista Lista;
typedef struct Nodo Nodo;

struct Nodo
{
    int dato;
    Nodo *siguiente;
};

struct Lista
{
    Nodo *inicio;
};

struct Estudiante
{
    char nombre[100];
    char carrera[100];
    char correo[200];
    int carnet, numero;
}est;

struct Sala{
    int capacidad;
    char ubicacion[TAMANO];
    char recursos[TAMANO];
    char estado[TAMANO];
    char id[TAMANO];
    char horario[TAMANO];
    int calificacion;
}sala;


struct Reserva{
    char estudiante[TAMANO];
    char id[TAMANO];
    char fecha[TAMANO];
    int inicio;
    int fin;
    int prioridad;
}reserva;

Lista *listaNueva(void)
{
    Lista *L;
    L = (Lista *) malloc(sizeof(Lista));
    L->inicio = NULL;
    return L;
}

void agregarEstudiante();
int verificarCarnet(Lista *L, int elemento);
void agregarSala();
void mostrarSalas();
void calificarSala(char id[30]);
void consultarSala(char sala[TAMANO]);
void crearReserva();


void agregarEstudiante()
{
    int M;
    Lista *L;
    printf("Indique el nombre: ");
    gets(est.nombre);
    printf("\nIndique la carrera: ");
    gets(est.carrera);
    printf("Indique el correo: ");
    gets(est.correo);
    printf("Indique el carnet: ");
    scanf("%d",&est.carnet);
    printf("Indique el numero telefonico: ");
    scanf("%d",&est.numero);
    FILE *ptr;
    ptr = fopen("Estudiante.txt", "a+");
    M = verificarCarnet(L,est.carnet);
    if(M==-1){
        fprintf(ptr,"%s\n",est.nombre);
        fprintf(ptr,"%s\n",est.carrera);
        fprintf(ptr,"%s\n",est.correo);
        fprintf(ptr,"%d\n",est.carnet);
        fprintf(ptr,"%d\n",est.numero);
        printf("DATOS GUARDADOS...");
    }else{
        int opcion;
        printf("Parece que este carnet ya esta registrado. Â¿Desea intentarlo de nuevo?\n\n[1] Intentar de nuevo\n[2] Ir al menu principal\n\n");
        scanf("%d", opcion);
        if(opcion == 1){
            return agregarEstudiante();
        }else
        {
            return;
        }
    }

    fclose(ptr);
}

int verificarCarnet(Lista *L, int elemento)
{
    FILE *ptr;
    ptr = fopen("nuevo.txt", "r");
    char linea[1024];
    int posicion = 0;
    while(fgets(linea, 1024, (FILE*) ptr)) {
        if(atoi(linea)==elemento){
            return posicion;
        }
        ++posicion;
    }
    return -1;
}

void agregarSala()
{
    FILE *Archivo;
    Archivo = fopen("Registro.dat","ab");

    printf("\nIndique el ID de la sala: ");
    scanf("%s",&sala.id);
    fprintf(Archivo,"%s\n",sala.id);

    printf("\nIndique los recursos de la sala(PIZARRA/PROYECTOR/AC/COMPUTADORA): ");
    scanf("%s",&sala.recursos);
    fprintf(Archivo,"%s\n",sala.recursos);
    printf("\nIndique el estado de la sala(ACTIVA/INACTIVA/MANTENIMIENTO): ");
    scanf("%s",&sala.estado);
    fprintf(Archivo,"%s\n",sala.estado);
    printf("\n[1]Biblioteca Jose Figueres Ferrer\n[2]Learning Commons\nIndique la ubicacion de la sala: ");
    scanf("%s",&sala.ubicacion);
    fprintf(Archivo,"%s\n",sala.ubicacion);
    printf("\nIndique el horario de operacion de la sala: ");
    scanf("%s",&sala.horario);
    fprintf(Archivo,"%s\n",sala.horario);
    printf("\nIndique la capacidad de la sala: ");
    scanf("%d",&sala.capacidad);
    fprintf(Archivo,"%d\n",sala.capacidad);
    calificarSala(strcat(sala.id,"\n"));
}

void mostrarSalas(){
    FILE *fich;
    fich = fopen("Registro.txt", "r");
    char registro[1024];
    while(fgets(registro, 1024, (FILE*) fich)) {//muestra todas las salas registradas
        printf(registro);
    }
}

void calificarSala(char id[30]){
    FILE *Archivo;
    Archivo = fopen("Calificaciones.dat","ab");
    printf("Indique la calificacion de la sala: ");
    scanf("%d",&sala.calificacion);

    fprintf(Archivo,"\n%s",id);
    fprintf(Archivo,"%d",sala.calificacion);

}

void consultarSala(char sala[TAMANO]){
    char registro[1024],reserva[1024],calif[1024];
    FILE *fich;
    fich = fopen("Registro.txt", "r");
    FILE *arch;
    FILE *Archivo;
    Archivo = fopen("Calificaciones.txt","r");
    arch = fopen("Reserva.txt","r");
    while(fgets(registro, 1024, (FILE*) fich)) {//esto agarra linea por linea toodo el documento
        if(strcmp(registro,sala)==0){
            printf("%s", registro);//ID
            printf(fgets(registro, 1024, (FILE*) fich));//RECURSOS
            printf(fgets(registro, 1024, (FILE*) fich));//ESTADO
            printf(fgets(registro, 1024, (FILE*) fich));//UBICACION
            printf(fgets(registro, 1024, (FILE*) fich));//HORARIO DE OPERACION
            printf(fgets(registro, 1024, (FILE*) fich));//CAPACIDAD
            while(fgets(calif, 1024, (FILE*) Archivo)){
                if(strcmp(calif,sala)==0){
                    printf(fgets(calif, 1024, (FILE*) Archivo));//CALIFICACION
                    while(fgets(reserva, 1024, (FILE*) arch)){
                        if(strcmp(reserva,sala)==0){
                            printf("\n");
                            printf(fgets(reserva, 1024, (FILE*) arch));//fecha de la reserva
                            printf(fgets(reserva, 1024, (FILE*) arch));//hora inicio reserva
                            printf(fgets(reserva, 1024, (FILE*) arch));//hora fin reserva
                        }
                    }
                }
            }
        }
    }
    fclose(Archivo);
    fclose(fich);
    fclose(arch);
}

void crearReserva()
{
    FILE *Archivo;
    Archivo = fopen("Reserva.dat","ab");
    printf("\nIngrese el carnet del estudiante: ");
    scanf("%s",&reserva.estudiante);
    fprintf(Archivo,"%s\n",reserva.estudiante);
    mostrarSalas();
    printf("Ingrese el ID de la sala: ");
    scanf("%s",&reserva.id);
    fprintf(Archivo,"%s\n",reserva.id);
    printf("\nIngrese la fecha de la reserva: ");
    scanf("%s",&reserva.fecha);
    fprintf(Archivo,"%s\n",reserva.fecha);
    printf("\nIngrese la hora en formato de 24 horas, sin AM O PM\nIngrese la hora de incio de la reserva de la sala: ");
    scanf("%d",&reserva.inicio);
    fprintf(Archivo,"%d\n",reserva.inicio);
    printf("\nIngrese la hora en formato de 24 horas, sin AM O PM\nIngrese la hora del final de la reserva de la sala: ");
    scanf("%d",&reserva.fin);
    fprintf(Archivo,"%d\n",reserva.fin);
    reserva.prioridad = rand() % 4;
    fprintf(Archivo,"%d\n",reserva.prioridad);


    fclose(Archivo);

}

void consultarReserva(char estudiante[50])
{
    char linea[1024];
    FILE *fich;
    fich = fopen("Reserva.dat", "r");
    while(fgets(linea, 1024, (FILE*) fich)) {//esto agarra linea por linea toodo el documento
        if(strcmp(estudiante,linea)==0){//esto agarra la sala ingresada en la funcion y dice si la encuentra en el documento
            printf(linea);//Estudiante
            printf(fgets(linea, 1024, (FILE*) fich));//ID  de la sala
            printf(fgets(linea, 1024, (FILE*) fich));//Hora de inicio de la reserva
            printf(fgets(linea, 1024, (FILE*) fich));//Hora del final de la reserva
            printf(fgets(linea, 1024, (FILE*) fich));//Fecha de la reserva

        }
    }
    fclose(fich);
}
